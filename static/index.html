<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizei - gerencie sua rotina de trabalho</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Organizei</h1>

        <!-- Botões de ação -->
        <div class="flex space-x-4 mb-6">
            <button onclick="openCreateWorkspaceModal()" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Criar Workspace</button>
            <button onclick="openCreateTeamModal()" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700">Criar Equipe</button>
            <button onclick="openCreateTaskModal()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">Criar Tarefa</button>
        </div>

        <!-- Seletor de Workspace -->
        <div class="mb-6">
            <label for="workspaceSelect" class="block text-lg font-semibold text-gray-700 mb-2">Espaço de Trabalho</label>
            <select id="workspaceSelect" onchange="loadWorkspaceData()" class="p-2 border rounded-lg w-full md:w-1/3">
                <option value="">Selecione um workspace</option>
            </select>
        </div>

        <!-- Lista de equipes -->
        <div id="teamSection" class="bg-white p-4 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Equipes</h2>
            <ul id="teamList" class="space-y-2"></ul>
        </div>

        <!-- Colunas de status -->
        <div id="taskBoard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-6 hidden">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Para Fazer</h2>
                <ul id="paraFazerList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Em Atraso</h2>
                <ul id="emAtrasoList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Pendente</h2>
                <ul id="pendenteList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Aguardando</h2>
                <ul id="aguardandoList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Aprovação</h2>
                <ul id="aprovacaoList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Aprovado</h2>
                <ul id="aprovadoList" class="space-y-4"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Concluído</h2>
                <ul id="concluidoList" class="space-y-4"></ul>
            </div>
        </div>
    </div>

    <!-- Modal para criar workspace -->
    <div id="createWorkspaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Criar Novo Workspace</h2>
            <input type="text" id="workspaceNameInput" placeholder="Nome do workspace" class="p-2 border rounded-lg w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeCreateWorkspaceModal()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button onclick="createWorkspace()" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal para criar equipe -->
    <div id="createTeamModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Criar Nova Equipe</h2>
            <input type="text" id="teamNameInput" placeholder="Nome da equipe" class="p-2 border rounded-lg w-full mb-4">
            <input type="text" id="teamMembersInputCreate" placeholder="Membros (separados por vírgula)" class="p-2 border rounded-lg w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeCreateTeamModal()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button onclick="createTeam()" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal para criar tarefa -->
    <div id="createTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Criar Nova Tarefa</h2>
            <input type="text" id="taskTitleInput" placeholder="Título da tarefa" class="p-2 border rounded-lg w-full mb-4">
            <textarea id="taskDescriptionInput" placeholder="Descrição (opcional)" class="p-2 border rounded-lg w-full mb-4"></textarea>
            <select id="taskPriorityInput" class="p-2 border rounded-lg w-full mb-4">
                <option value="Baixa">Baixa</option>
                <option value="Média" selected>Média</option>
                <option value="Alta">Alta</option>
            </select>
            <input type="date" id="taskStartDateInput" placeholder="Data de Início" class="p-2 border rounded-lg w-full mb-4">
            <input type="date" id="taskDueDateInput" placeholder="Data de Vencimento" class="p-2 border rounded-lg w-full mb-4">
            <select id="taskAssignedToInput" class="p-2 border rounded-lg w-full mb-4">
                <option value="">Sem atribuição</option>
            </select>
            <div class="flex justify-end space-x-2">
                <button onclick="closeCreateTaskModal()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button onclick="createTask()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar equipe -->
    <div id="editTeamModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Editar Equipe</h2>
            <input type="text" id="teamMembersInput" placeholder="Membros (separados por vírgula)" class="p-2 border rounded-lg w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditTeamModal()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button onclick="saveTeamChanges()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/remover membros -->
    <div id="addTeamMembersModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Gerenciar Membros da Equipe</h2>
            <p id="currentMembers" class="text-sm text-gray-600 mb-4">Membros atuais: Nenhum</p>
            <input type="text" id="addMembersInput" placeholder="Adicionar membros (separados por vírgula)" class="p-2 border rounded-lg w-full mb-4">
            <input type="text" id="removeMembersInput" placeholder="Remover membros (separados por vírgula)" class="p-2 border rounded-lg w-full mb-4">
            <p id="addMembersMessage" class="text-sm text-red-500 mb-4 hidden"></p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeAddTeamMembersModal()" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button onclick="addTeamMembers()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let currentWorkspaceId = null;
        let currentTeamId = null;
        let currentTeamMembers = [];

        async function loadWorkspaces() {
            const response = await fetch('/workspaces');
            const workspaces = await response.json();
            const workspaceSelect = document.getElementById('workspaceSelect');
            workspaceSelect.innerHTML = '<option value="">Selecione um workspace</option>';
            workspaces.forEach(workspace => {
                const option = document.createElement('option');
                option.value = workspace.id;
                option.textContent = workspace.name;
                workspaceSelect.appendChild(option);
            });
        }

        async function loadWorkspaceData() {
            const workspaceSelect = document.getElementById('workspaceSelect');
            currentWorkspaceId = workspaceSelect.value;
            if (!currentWorkspaceId) {
                document.getElementById('teamSection').classList.add('hidden');
                document.getElementById('taskBoard').classList.add('hidden');
                return;
            }

            document.getElementById('teamSection').classList.remove('hidden');
            document.getElementById('taskBoard').classList.remove('hidden');

            const response = await fetch('/workspaces');
            const workspaces = await response.json();
            const workspace = workspaces.find(w => w.id == currentWorkspaceId);
            const teamList = document.getElementById('teamList');
            const assignedToInput = document.getElementById('taskAssignedToInput');
            teamList.innerHTML = '';
            assignedToInput.innerHTML = '<option value="">Sem atribuição</option>';

            workspace.teams.forEach(team => {
                const li = document.createElement('li');
                li.innerHTML = `${team.name}: ${team.members.join(', ')} 
                    <button onclick="openEditTeamModal(${team.id}, '${team.members.join(', ')}')" class="text-blue-500 hover:underline">Editar</button>
                    <button onclick="openAddTeamMembersModal(${team.id}, '${team.members.join(', ')}')" class="text-green-500 hover:underline ml-2">Gerenciar Membros</button>`;
                li.className = 'p-2 bg-gray-50 rounded';
                teamList.appendChild(li);

                team.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    assignedToInput.appendChild(option);
                });
            });

            loadTasks();
        }

        async function loadTasks() {
            if (!currentWorkspaceId) return;
            const response = await fetch(`/tasks?workspace_id=${currentWorkspaceId}`);
            const tasks = await response.json();

            const paraFazerList = document.getElementById('paraFazerList');
            const emAtrasoList = document.getElementById('emAtrasoList');
            const pendenteList = document.getElementById('pendenteList');
            const aguardandoList = document.getElementById('aguardandoList');
            const aprovacaoList = document.getElementById('aprovacaoList');
            const aprovadoList = document.getElementById('aprovadoList');
            const concluidoList = document.getElementById('concluidoList');

            paraFazerList.innerHTML = '';
            emAtrasoList.innerHTML = '';
            pendenteList.innerHTML = '';
            aguardandoList.innerHTML = '';
            aprovacaoList.innerHTML = '';
            aprovadoList.innerHTML = '';
            concluidoList.innerHTML = '';

            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-50 rounded-lg shadow-sm';
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-800">${task.title}</h3>
                            <p class="text-sm text-gray-600">${task.description || ''}</p>
                            <p class="text-xs text-gray-500">Prioridade: ${task.priority}</p>
                            <p class="text-xs text-gray-500">Início: ${task.start_date || 'Não definido'}</p>
                            <p class="text-xs text-gray-500">Vencimento: ${task.due_date || 'Não definido'}</p>
                            <p class="text-xs text-gray-500">Criada em: ${task.created_at}</p>
                            <p class="text-xs text-gray-500">Atribuído a: ${task.assigned_to || 'Ninguém'}</p>
                        </div>
                        <select onchange="updateTask(${task.id}, this.value)" class="p-1 border rounded">
                            <option value="Para Fazer" ${task.status === 'Para Fazer' ? 'selected' : ''}>Para Fazer</option>
                            <option value="Em Atraso" ${task.status === 'Em Atraso' ? 'selected' : ''}>Em AMoethod "traso</option>
                            <option value="Pendente" ${task.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="Aguardando" ${task.status === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                            <option value="Aprovação" ${task.status === 'Aprovação' ? 'selected' : ''}>Aprovação</option>
                            <option value="Aprovado" ${task.status === 'Aprovado' ? 'selected' : ''}>Aprovado</option>
                            <option value="Concluído" ${task.status === 'Concluído' ? 'selected' : ''}>Concluído</option>
                        </select>
                    </div>
                `;
                if (task.status === 'Para Fazer') paraFazerList.appendChild(li);
                else if (task.status === 'Em Atraso') emAtrasoList.appendChild(li);
                else if (task.status === 'Pendente') pendenteList.appendChild(li);
                else if (task.status === 'Aguardando') aguardandoList.appendChild(li);
                else if (task.status === 'Aprovação') aprovacaoList.appendChild(li);
                else if (task.status === 'Aprovado') aprovadoList.appendChild(li);
                else if (task.status === 'Concluído') concluidoList.appendChild(li);
            });
        }

        // Funções para o modal de workspace
        function openCreateWorkspaceModal() {
            document.getElementById('createWorkspaceModal').classList.remove('hidden');
        }
        function closeCreateWorkspaceModal() {
            document.getElementById('createWorkspaceModal').classList.add('hidden');
        }
        async function createWorkspace() {
            const name = document.getElementById('workspaceNameInput').value.trim();
            if (name) {
                await fetch('/workspaces', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                document.getElementById('workspaceNameInput').value = '';
                closeCreateWorkspaceModal();
                loadWorkspaces();
            }
        }

        // Funções para o modal de equipe
        function openCreateTeamModal() {
            if (!currentWorkspaceId) {
                alert('Selecione um workspace primeiro!');
                return;
            }
            document.getElementById('createTeamModal').classList.remove('hidden');
        }
        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').classList.add('hidden');
        }
        async function createTeam() {
            const name = document.getElementById('teamNameInput').value.trim();
            const membersInput = document.getElementById('teamMembersInputCreate').value;
            const members = membersInput.split(',').map(m => m.trim()).filter(m => m);
            if (name && currentWorkspaceId) {
                await fetch('/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, members, workspace_id: parseInt(currentWorkspaceId) })
                });
                document.getElementById('teamNameInput').value = '';
                document.getElementById('teamMembersInputCreate').value = '';
                closeCreateTeamModal();
                loadWorkspaceData();
            }
        }

        // Funções para o modal de tarefa
        function openCreateTaskModal() {
            if (!currentWorkspaceId) {
                alert('Selecione um workspace primeiro!');
                return;
            }
            document.getElementById('createTaskModal').classList.remove('hidden');
        }
        function closeCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('hidden');
        }
        async function createTask() {
            const title = document.getElementById('taskTitleInput').value.trim();
            const description = document.getElementById('taskDescriptionInput').value.trim();
            const priority = document.getElementById('taskPriorityInput').value;
            const start_date = document.getElementById('taskStartDateInput').value || null;
            const due_date = document.getElementById('taskDueDateInput').value || null;
            const assigned_to = document.getElementById('taskAssignedToInput').value || null;
            if (title && currentWorkspaceId) {
                await fetch('/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, priority, start_date, due_date, assigned_to, workspace_id: parseInt(currentWorkspaceId) })
                });
                document.getElementById('taskTitleInput').value = '';
                document.getElementById('taskDescriptionInput').value = '';
                document.getElementById('taskPriorityInput').value = 'Média';
                document.getElementById('taskStartDateInput').value = '';
                document.getElementById('taskDueDateInput').value = '';
                document.getElementById('taskAssignedToInput').value = '';
                closeCreateTaskModal();
                loadTasks();
            }
        }

        // Funções para o modal de edição de equipe
        function openEditTeamModal(teamId, members) {
            currentTeamId = teamId;
            document.getElementById('teamMembersInput').value = members;
            document.getElementById('editTeamModal').classList.remove('hidden');
        }
        function closeEditTeamModal() {
            document.getElementById('editTeamModal').classList.add('hidden');
        }
        async function saveTeamChanges() {
            const membersInput = document.getElementById('teamMembersInput').value;
            const members = membersInput.split(',').map(m => m.trim()).filter(m => m);
            if (currentTeamId) {
                await fetch(`/teams/${currentTeamId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ members })
                });
                closeEditTeamModal();
                loadWorkspaceData();
            }
        }

        // Funções para o modal de adicionar/remover membros
        function openAddTeamMembersModal(teamId, members) {
            currentTeamId = teamId;
            currentTeamMembers = members.split(', ').filter(m => m);
            document.getElementById('currentMembers').textContent = `Membros atuais: ${currentTeamMembers.join(', ') || 'Nenhum'}`;
            document.getElementById('addMembersInput').value = '';
            document.getElementById('removeMembersInput').value = '';
            document.getElementById('addMembersMessage').classList.add('hidden');
            document.getElementById('addTeamMembersModal').classList.remove('hidden');
        }
        function closeAddTeamMembersModal() {
            document.getElementById('addTeamMembersModal').classList.add('hidden');
        }
        async function addTeamMembers() {
            const addInput = document.getElementById('addMembersInput').value;
            const removeInput = document.getElementById('removeMembersInput').value;
            const newMembers = addInput.split(',').map(m => m.trim()).filter(m => m);
            const membersToRemove = removeInput.split(',').map(m => m.trim()).filter(m => m);

            const duplicates = newMembers.filter(m => currentTeamMembers.includes(m));
            if (duplicates.length > 0) {
                const message = document.getElementById('addMembersMessage');
                message.textContent = `Membros já existentes: ${duplicates.join(', ')}`;
                message.classList.remove('hidden');
                return;
            }

            if (currentTeamId && (newMembers.length > 0 || membersToRemove.length > 0)) {
                if (newMembers.length > 0) {
                    await fetch(`/teams/${currentTeamId}/members`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ members: newMembers })
                    });
                }
                if (membersToRemove.length > 0) {
                    await fetch(`/teams/${currentTeamId}/members`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ members: membersToRemove })
                    });
                }
                document.getElementById('addMembersInput').value = '';
                document.getElementById('removeMembersInput').value = '';
                closeAddTeamMembersModal();
                loadWorkspaceData();
            }
        }

        async function updateTask(taskId, status) {
            const assignedToInput = document.getElementById('taskAssignedToInput');
            const assigned_to = assignedToInput.value || null;
            await fetch(`/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status, assigned_to })
            });
            loadTasks();
        }

        // Carregar workspaces ao abrir a página
        loadWorkspaces();
    </script>
</body>
</html>